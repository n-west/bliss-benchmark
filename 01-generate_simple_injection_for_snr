#!/usr/bin/env python3

import os
os.environ['SETIGEN_ENABLE_GPU'] = '0'
os.environ['CUDA_VISIBLE_DEVICES'] = '1'

import setigen as stg
import numpy as np
import argparse

parser = argparse.ArgumentParser(description="generate hdf5 filterbank files from voltages with given noise distribution and a single injected signal")

parser.add_argument('--snr', type=float, dest='snr', default=1000,
                    help='target snr of injected signal (default: 1000)')

parser.add_argument('-d', '--drift', type=float, dest='drift', default=3.4,
                    help='Drift value (default: 3.4)')

parser.add_argument('--fwhm', type=float, dest='fwhm', default=8,
                    help='FWHM value to pass to quantizers (used to renormalize data)')

args = parser.parse_args()

target_snr = args.snr
drift_rate = args.drift
fwhm = args.fwhm

subsample_factor = 4

sample_rate = 3e9 / subsample_factor
num_taps = 8
num_branches = 1024 // subsample_factor


chan_bw = sample_rate / num_branches

digitizer = stg.voltage.RealQuantizer(target_fwhm=fwhm,
                                      num_bits=8)

filterbank = stg.voltage.PolyphaseFilterbank(num_taps=num_taps,
                                             num_branches=num_branches)

requantizer = stg.voltage.ComplexQuantizer(target_fwhm=fwhm,
                                           num_bits=8)

num_pols = 2
antenna = stg.voltage.Antenna(sample_rate=sample_rate,
                              fch1=6000e6,
                              ascending=True,
                              num_pols=num_pols,
                              seed=42)

fftlength = 2**20 # 1048576 (expected fine channelization down the pipe)
#int_factor = 51
#
#block_size = stg.voltage.get_block_size(num_antennas=1,
#                                        tchans_per_block=1,
#                                        num_bits=8,
#                                        num_pols=2,
#                                        num_branches=num_branches,
#                                        num_chans=num_branches//2,
#                                        fftlength=fftlength,
#                                        int_factor=int_factor)
block_size = 134217728

rvb = stg.voltage.RawVoltageBackend(antenna,
                                    digitizer=digitizer,
                                    filterbank=filterbank,
                                    requantizer=requantizer,
                                    start_chan=1,
                                    num_chans=1,
                                    block_size=block_size,
                                    blocks_per_file=128,
                                    num_subblocks=64)


# Add noise
for stream in antenna.streams:
    stream.add_noise(v_mean=0,
                     v_std=1)

obs_length = 300
# Add signals
signal_level = stg.voltage.get_level(target_snr,
                                     rvb,
                                     obs_length=obs_length,
                                     length_mode='obs_length',
                                     fftlength=fftlength)

unit_drift_rate = stg.voltage.get_unit_drift_rate(rvb, fftlength, 1)
print(f"unit drift rate: {unit_drift_rate}")

chan_bw = sample_rate / num_branches
df = np.abs(chan_bw / fftlength)

f_start = 6000.e6 + sample_rate/num_branches + .4e6
leakage_factor = stg.voltage.get_leakage_factor(f_start, rvb, fftlength)
print(f"reported leakage factor is {leakage_factor}")
leakage_factor = 1
for stream in antenna.streams:
    level = stream.get_total_noise_std() * leakage_factor * signal_level
    stream.add_constant_signal(f_start=f_start,
                                drift_rate=drift_rate,
                                level=level)

DATA_DIR = '/datax/scratch/nwest/voltage-gen/'
rvb.record(output_file_stem=f'{DATA_DIR}/singlecoarse_fwhm={fwhm}_injected_f={f_start}_snr={target_snr}_drift={drift_rate}',
           obs_length=obs_length,
           length_mode='obs_length',
           header_dict={'HELLO': 'test_value',
                        'TELESCOP': 'GBT'},
           verbose=False)



